name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  schedule:
    - cron: "0 0 * * 0"
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-lint-v1

      - name: Install formatters
        run: |
          command -v taplo || cargo install taplo-cli
          command -v dprint || cargo install dprint
          sudo apt-get install -y shfmt jq shellcheck
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Check Markdown formatting (dprint)
        run: dprint check .

      - name: Check TOML formatting (taplo)
        run: taplo fmt --check

      - name: Check shell formatting (shfmt)
        run: shfmt -d -i 4 sync.sh

      - name: Check JSON formatting (jq)
        run: |
          for f in obsidian/*.json; do
            jq '.' "$f" > /tmp/formatted.json
            diff -q "$f" /tmp/formatted.json || (echo "FAIL: $f not formatted" && exit 1)
          done

      - name: Lint shell scripts (shellcheck)
        run: |
          bash -n sync.sh
          shellcheck sync.sh

      - name: Validate Brewfile syntax
        run: ruby -c Brewfile

      - name: Validate YAML syntax
        run: |
          find . -name '*.yml' -o -name '*.yaml' | while read -r f; do
            echo "Checking $f"
            yq '.' "$f" > /dev/null || exit 1
          done

      - name: Check for trailing whitespace
        run: |
          ! grep -rn '[[:space:]]$' --include="*.md" --include="*.toml" --include="*.sh" .

  test:
    runs-on: macos-15
    needs: lint
    steps:
      - uses: actions/checkout@v6

      - name: Validate Brewfile syntax
        run: brew bundle list --file=Brewfile

      - name: Install minimal deps
        run: brew install neovim zoxide nvm rustup fd starship atuin uv

      - name: Setup configs
        run: make configs

      - name: Install neovim plugins
        run: make nvim-plugins

      - name: Verify neovim loads
        run: nvim --headless -c "quit"

      - name: Set macos defaults
        run: make macos

      - name: Setup devenv
        run: make devenv LEAN_FULL=false
